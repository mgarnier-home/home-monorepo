image: docker:24.0.7

.build-template: &build-template
  stage: build apps
  script:
    - docker build -t mgarnier11/$PROJECT_NAME:$TAG_NAME -f app/$PROJECT_NAME/docker/Dockerfile . --push
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
      changes:
        - apps/$PROJECT_NAME/**/*

include:
  - 'apps/**/.gitlab-ci.yml'
  - 'libs/**/.gitlab-ci.yml'

stages:
  - install dependencies
  - build apps
  - manifest apps

before_script:
  - docker login -u mgarnier11 -p $DOCKER_HUB_TOKEN
  - docker buildx create --use
services:
  - docker:24.0.7-dind
variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ''

.rules-deps: &rules-deps
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
      changes:
        - 'docker/**'
        - '**/package.json'
        - '**/.gitlab-ci.yml'
        - 'pnpm-lock.yaml'

install dependencies amd64:
  stage: install dependencies
  script:
    - docker build -t mgarnier11/my-home:amd64 -f docker/Dockerfile . --push
  <<: *rules-deps

install dependencies arm64:
  stage: install dependencies
  tags:
    - arm64
  script:
    - docker build -t mgarnier11/my-home:arm64 -f docker/Dockerfile . --push
  <<: *rules-deps
